title: "Developer Bugfix Workflow"
output: "dev_bugfix_workflow"
variables:
  demo_dir: "{{tmp_dir}}/terminal_demo_studio_devflow"
settings:
  width: 1440
  height: 900
  font_size: 22
  theme: "Catppuccin Mocha"
  padding: 24
  window_bar: "Colorful"
  framerate: 60
  line_height: 1.15
  letter_spacing: 0
preinstall:
  - "rm -rf {{demo_dir}} && mkdir -p {{demo_dir}}"
  - |
    cat > {{demo_dir}}/mathlib_after.py <<'PY'
    def add(a, b):
        return a + b

    def multiply(a, b):
        return a * b
    PY
  - |
    cat > {{demo_dir}}/mathlib_before.py <<'PY'
    def add(a, b):
        # regression introduced during refactor
        return a - b

    def multiply(a, b):
        return a * b
    PY
  - "cp {{demo_dir}}/mathlib_after.py {{demo_dir}}/mathlib.py"
  - |
    cat > {{demo_dir}}/test_mathlib.py <<'PY'
    import unittest
    from mathlib import add, multiply

    class MathTests(unittest.TestCase):
        def test_add(self):
            self.assertEqual(add(2, 3), 5)

        def test_multiply(self):
            self.assertEqual(multiply(4, 3), 12)

    if __name__ == '__main__':
        unittest.main()
    PY
  - |
    cat > {{demo_dir}}/summarize_add.py <<'PY'
    from mathlib import add

    print(f"add_2_3={add(2, 3)} expected=5")
    PY
  - "cd {{demo_dir}} && git init -q && git config user.email demo@local && git config user.name Demo && git add . && git commit -qm 'chore: seed math module'"
scenarios:
  - label: "Before Fix"
    surface: "terminal"
    setup:
      - "cd {{demo_dir}}"
      - "cp mathlib_before.py mathlib.py"
    actions:
      - type: "cd {{demo_dir}}"
      - type: "git log --oneline -n 2"
      - type: "git status -sb"
      - type: "git diff -- mathlib.py"
      - type: "python3 -m unittest -q"
      - wait_for: "FAIL:"
        wait_mode: "screen"
        wait_timeout: "8s"
      - type: "python3 summarize_add.py"
      - sleep: "1200ms"
  - label: "After Fix"
    surface: "terminal"
    setup:
      - "cd {{demo_dir}}"
      - "cp mathlib_after.py mathlib.py"
    actions:
      - type: "cd {{demo_dir}}"
      - type: "git status -sb"
      - type: "git diff -- mathlib.py"
      - type: "python3 -m unittest -q"
      - wait_for: "OK"
        wait_mode: "screen"
        wait_timeout: "8s"
      - type: "python3 summarize_add.py"
      - sleep: "1200ms"
